from machine import Pin, time_pulse_us
from time import sleep
import network
import urequests

# === Configuration ===
TRIG_PIN = 5
ECHO_PIN = 18
BIN_HEIGHT_CM = 20  # Height of garbage bin in cm

WIFI_SSID = 'mi 10 pro'
WIFI_PASSWORD = '12345678'

TELEGRAM_BOT_TOKEN = '7995788841:AAEchzde2yR3_LzBlbkTnfpchw99Mvo7TWY'
CHAT_ID = '920533803'

# === Setup Pins ===
trig = Pin(TRIG_PIN, Pin.OUT)
echo = Pin(ECHO_PIN, Pin.IN)

# === Connect to WiFi ===
def connect_wifi():
    wlan = network.WLAN(network.STA_IF)
    wlan.active(True)
    if not wlan.isconnected():
        print("Connecting to WiFi...")
        wlan.connect(WIFI_SSID, WIFI_PASSWORD)
        while not wlan.isconnected():
            pass
    print("Connected to WiFi:", wlan.ifconfig())

# === Measure Distance ===
def measure_distance():
    trig.off()
    sleep(0.05)
    trig.on()
    sleep(0.00001)
    trig.off()
    try:
        duration = time_pulse_us(echo, 1, 30000)
        if duration <= 0:
            return BIN_HEIGHT_CM
        distance_cm = (duration / 2) / 29.1
        return distance_cm
    except:
        return BIN_HEIGHT_CM  # Return full bin height if error

# === Send Telegram Message ===
def send_telegram_message(message):
    try:
        url = f"https://api.telegram.org/bot{TELEGRAM_BOT_TOKEN}/sendMessage"
        data = {
            'chat_id': CHAT_ID,
            'text': message
        }
        response = urequests.post(url, json=data)
        response.close()
        print("Telegram message sent.")
    except Exception as e:
        print("Failed to send message:", e)

# === Main Program ===
connect_wifi()
send_telegram_message("Connected to WiFi. IP address: {}".format(network.WLAN(network.STA_IF).ifconfig()[0]))

alert_sent = False

while True:
    distance = measure_distance()
    if distance > BIN_HEIGHT_CM:
        distance = BIN_HEIGHT_CM

    fill_percent = int(((BIN_HEIGHT_CM - distance) / BIN_HEIGHT_CM) * 100)

    # Send status to Telegram every time
    status_message = "Bin Report:\nDistance: {:.1f} cm\nFill Level: {}%".format(distance, fill_percent)
    send_telegram_message(status_message)

    # Send alert only once when full
    if fill_percent >= 90 and not alert_sent:
        alert_message = "ALERT: Garbage bin is {}% full. Please empty it.".format(fill_percent)
        send_telegram_message(alert_message)
        alert_sent = True
    elif fill_percent < 90:
        alert_sent = False  # Reset if level drops again

    sleep(30)  # Delay before next reading
